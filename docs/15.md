## 15. 리덕스 미들웨어와 외부 데이터 연동


서버의 REST API를 호출할 때는 요청 후 로딩, 응답에 따른 성공, 실패 세 가지 상태를 관리해야한다. 리액트 컴포넌트의 state만 사용해도 관리할 수 있으나, 리덕스와 리덕스 미들웨어를 사용하면 상태를 간편하게 관리할 수 있다.


### 미들웨어

리덕스 미들웨어는 액션과 리듀서의 중간자로, 액션을 디스패치 했을 때 리듀서에서 처리하기 전에 지정된 작업을 실행한다.

create-react-app으로 만든 프로젝트에 Ducks 구조를 사용하여 리덕스를 적용한 단순 프로젝트 클론. 간단산 숫자 카운터가 구현되어 있으며, store 생성 로직은 store.js 파일로 분리

```shell
$ git clone https://github.com/vlpt-playground/redux-starter-kit.git
$ cd redux-starter-kit
$ yarn
```

```js
// src/lib/loggerMiddleware.js
const loggerMiddleware = store => next => action => {
    /* 미들웨어 내용 */
};
```

next는 store.dispatch와 비슷한 역할로, 처리해야 할 미들웨어가 있다면 미들웨어로, 없다면 리듀서로 액션을 전달한다.

미들웨어는 store를 생성할 때 적용할 수 있다.

```js
const store = createStore(modules, applyMiddleware(loggerMiddleware));
```

미들웨어에서는 액션정보에 따라 무시하거나(next 호출 않고 return), 액션 정보를 수정한 후 리듀서에 전달할 수도 있다. 특히 네트워크 요청과 같은 비동기 작업을 할 때 매우 유용하다.


#### redux-logger 라이브러리 사용

```shell
$ yarn add redux-logger
```


### 오픈소스 미들웨어

#### redux-thunk

리덕스 애플리케이션에서 비동기 작업을 처리할 때 가장 기본적인 방법은 redux-thunk를 사용하는 것이다.

thunk는 특정 작업을 나중에 할 수 있도록 미루려고 함수 형태로 감싼 것이다. `const foo = () => 1+2;` 이면 1+2 연산을 지금 하지 않고 나중에 foo()를 호출할 때 연산한다.

이 미들웨어는 객체가 아닌 함수도 디스패치할 수 있게 한다. 일반 액션 객체는 바로 반영이 되지만, 미들웨어를 사용해 몇 초 뒤에 실제로 반영시키거나 현재 상태에 따라 무시하는 로직의 함수를 디스패치하여 원하는 작업을 수행할 수 있다.

```js
const INCREMENT_COUNTER = "INCREMENT_COUNTER";

function increment() {
  return {
    type: INCREMENT_COUNTER
  };
}

function incrementAsync() {
  return dispatch => {  // dispatch를 파라미터로 가지는 함수를 리턴합니다.
    setTimeout(() => {  // 1초 뒤 dispatch 합니다.
      dispatch(increment());
    }, 1000);
  };
}
```

```js
function incrementIfOdd() {
  return (dispatch, getState) => {
    const { counter } = getState();

    if (counter % 2 === 0) {  // 짝수이면 무시
      return;
    }

    dispatch(increment());  // 홀수일 때 상태 변화
  };
}
```

객체가 아니라 함수를 반환하는 함수는 액션 생성 함수라 하지 않고 thunk 생성 함수라고 한다. thunk 생성 함수에서는 dispatch와 getState를 파라미터로 가지는 새로운 함수를 만들어 반환해야 한다. 이곳에서 네트워크 요청을 하거나 다른 종류의 액션들을 여러번 디스패치 할 수도 있다.

```shell
$ yarn add redux-thunk
```
